# Shared Android Fastlane Configuration
# Usage: fastlane android dev/prod

require_relative '../shared/helpers'

default_platform(:android)

platform :android do

  before_all do
    skip_docs
    # Detect project root from CI or local path
    @project_root = ENV["GITHUB_WORKSPACE"] ||        # GitHub Actions
                    ENV["CI_PROJECT_DIR"] ||          # GitLab
                    ENV["BUILD_SOURCESDIRECTORY"] ||  # Azure DevOps
                    find_project_root
    
    UI.user_error!("❌ Could not find Flutter project root!") unless @project_root
  end

  desc "Deploy to Play Store Production"
  lane :prod do
    deploy(track: "production")
  end

  desc "Deploy to Play Store Beta"
  lane :dev do
    deploy(track: "beta")
  end

  # Generic deploy logic using build artifact or manual build
  desc "Execute Play Store upload"
  lane :deploy do |options|
    track = options[:track] || "beta"

    aab_file = find_latest_aab(@project_root)
    unless aab_file && File.exist?(aab_file)
      UI.user_error!("❌ AAB file not found! Run 'flutter build appbundle' first.")
    end
    
    upload_to_play_store(
      aab: aab_file,
      track: track,
      metadata_path: env_with_flavor('ANDROID_METADATA_PATH') || "metadata",
      skip_upload_metadata: true,
      release_status: "completed"
    )
  end
end
