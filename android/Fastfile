require 'fileutils'

# Shared helper methods (Standalone)
def log_info(message)
  UI.message("üìù #{message}")
end

def dump_context
  UI.message("----------------------------------------------------")
  UI.message("üõ†Ô∏è  Android Build Context Dump")
  UI.message("----------------------------------------------------")
  
  keys = [
    'FLAVOR',
    'ANDROID_PACKAGE_NAME',
    'ANDROID_SERVICE_ACCOUNT_JSON',
    'ANDROID_SERVICE_ACCOUNT_PATH',
    'ANDROID_METADATA_PATH'
  ]
  
  flavor = ENV['FLAVOR']
  if flavor && !flavor.empty?
    keys += keys.map { |k| "#{flavor.upcase}_#{k}" }
  end

  keys.uniq.each do |key|
    value = ENV[key]
    if value && !value.empty?
      masked = (key.include?('JSON') || key.include?('KEY')) && value.length > 20 ? "#{value[0..4]}...#{value[-4..-1]}" : value
      UI.message("   üîπ #{key}: #{masked}")
    else
      # UI.message("   üî∏ #{key}: [nil/empty]")
    end
  end
  UI.message("----------------------------------------------------")
end

def env_with_flavor(key)
  flavor = ENV['FLAVOR']
  value = nil
  if flavor && !flavor.empty?
    flavor_key = "#{flavor.upcase}_#{key}"
    value = ENV[flavor_key] if ENV[flavor_key] && !ENV[flavor_key].empty?
  end
  value = ENV[key] if value.nil?
  value
end

def find_project_root
  dir = Dir.pwd
  while dir != '/'
    return dir if File.exist?(File.join(dir, 'pubspec.yaml'))
    dir = File.dirname(dir)
  end
  nil
end

def find_latest_aab(project_root)
  log_info("Searching for AAB in: #{project_root}/build/app/outputs/bundle")
  aab_pattern = File.join(project_root, "build/app/outputs/bundle/**/*.aab")
  aab_files = Dir.glob(aab_pattern)
  latest = aab_files.max_by { |f| File.mtime(f) }
  log_info("Found AAB: #{latest}") if latest
  latest
end

def get_metadata_path(platform_prefix, project_root)
  default_subpath = platform_prefix.downcase == 'android' ? "android/fastlane/metadata" : "ios/fastlane/metadata"
  relative_path = env_with_flavor("#{platform_prefix}_METADATA_PATH") || default_subpath
  full_path = File.expand_path(relative_path, project_root)
  nested_path = File.join(full_path, platform_prefix.downcase)
  
  final_path = Dir.exist?(nested_path) ? nested_path : full_path
  log_info("Metadata Path resolved to: #{final_path}")
  final_path
end

def ensure_metadata_dirs(platform_prefix, project_root)
  log_info("Checking metadata directories...")
  metadata_path = get_metadata_path(platform_prefix, project_root)
  
  locales_env = env_with_flavor("SUPPORTED_LOCALES") || "tr-TR"
  locales = locales_env.split(',').map(&:strip)
  
  log_info("Supported locales: #{locales}")

  # 1. Create missing directories
  locales.each do |locale|
    dir = File.join(metadata_path, locale, "changelogs")
    FileUtils.mkdir_p(dir)
    file = File.join(dir, "default.txt")
    unless File.exist?(file)
      log_info("Creating default changelog for #{locale}")
      content = locale.start_with?('tr') ? "- Hata d√ºzeltmeleri ve performans iyile≈ütirmeleri." : "- Bug fixes and performance improvements."
      File.write(file, content)
    end
  end

  # 2. Cleanup unsupported directories
  if Dir.exist?(metadata_path)
    existing_dirs = Dir.children(metadata_path).select { |d| File.directory?(File.join(metadata_path, d)) }
    to_remove = existing_dirs - locales
    to_remove.each do |dir_name|
      full_path = File.join(metadata_path, dir_name)
      log_info("Removing unsupported locale directory: #{dir_name}")
      FileUtils.rm_rf(full_path)
    end
  end
end

default_platform(:android)

platform :android do

  before_all do
    skip_docs
    update_fastlane
    dump_context

    # Detect project root from CI or local path
    @project_root = ENV["GITHUB_WORKSPACE"] ||        # GitHub Actions
                    ENV["CI_PROJECT_DIR"] ||          # GitLab
                    ENV["BUILD_SOURCESDIRECTORY"] ||  # Azure DevOps
                    find_project_root
    
    UI.user_error!("‚ùå Could not find Flutter project root!") unless @project_root
    log_info("Project Root: #{@project_root}")

    # Ensure metadata structure exists
    ensure_metadata_dirs("ANDROID", @project_root)
  end

  desc "Deploy to Play Store Production"
  lane :prod do
    log_info("Starting PROD deployment (Production)...")
    deploy(track: "production")
  end

  desc "Deploy to Play Store Beta"
  lane :dev do
    log_info("Starting DEV deployment (Beta)...")
    deploy(track: "beta")
  end

  # Generic deploy logic using build artifact or manual build
  desc "Execute Play Store upload"
  lane :deploy do |options|
    track = options[:track] || "beta"

    aab_file = find_latest_aab(@project_root)
    unless aab_file && File.exist?(aab_file)
      UI.user_error!("‚ùå AAB file not found! Run 'flutter build appbundle' first.")
    end
    
    metadata_path = get_metadata_path('ANDROID', @project_root)
    metadata_exists = Dir.exist?(metadata_path)
    log_info("Metadata exists: #{metadata_exists}")

    # Authenticate with Google Play
    json_key_path = env_with_flavor('ANDROID_SERVICE_ACCOUNT_PATH').to_s.strip
    json_key_data = env_with_flavor('ANDROID_SERVICE_ACCOUNT_JSON').to_s.strip
    package_name = env_with_flavor("ANDROID_PACKAGE_NAME").to_s.strip
    
    params = {
      aab: aab_file,
      track: track,
      metadata_path: metadata_exists ? metadata_path : nil,
      skip_upload_metadata: !metadata_exists,
      skip_upload_images: !metadata_exists,
      skip_upload_screenshots: !metadata_exists,
      skip_upload_changelogs: !metadata_exists,
      release_status: "completed"
    }

    if package_name.empty?
      UI.user_error!("‚ùå ANDROID_PACKAGE_NAME is missing!") 
    else
      log_info("Package Name: #{package_name}")
      params[:package_name] = package_name
    end
    
    if !json_key_data.empty?
      log_info("Auth: Using JSON Data content")
      params[:json_key_data] = json_key_data
    elsif !json_key_path.empty?
      log_info("Auth: Using JSON Key Path: #{json_key_path}")
      params[:json_key] = json_key_path
    else
      UI.user_error!("‚ùå No Service Account JSON or Path provided!")
    end

    upload_to_play_store(params)
  end
end
