# Shared Android Fastlane Configuration
# Usage: fastlane android dev/prod

# Shared helper methods (Standalone)
def env_with_flavor(key)
  flavor = ENV['FLAVOR']
  if flavor && !flavor.empty?
    flavor_key = "#{flavor.upcase}_#{key}"
    return ENV[flavor_key] if ENV[flavor_key] && !ENV[flavor_key].empty?
  end
  ENV[key]
end

def find_project_root
  dir = Dir.pwd
  while dir != '/'
    return dir if File.exist?(File.join(dir, 'pubspec.yaml'))
    dir = File.dirname(dir)
  end
  nil
end

def find_latest_aab(project_root)
  aab_pattern = File.join(project_root, "build/app/outputs/bundle/**/*.aab")
  aab_files = Dir.glob(aab_pattern)
  return aab_files.max_by { |f| File.mtime(f) }
end

def get_metadata_path(platform_prefix, project_root)
  default_subpath = platform_prefix.downcase == 'android' ? "android/fastlane/metadata" : "ios/fastlane/metadata"
  relative_path = env_with_flavor("#{platform_prefix}_METADATA_PATH") || default_subpath
  full_path = File.expand_path(relative_path, project_root)
  nested_path = File.join(full_path, platform_prefix.downcase)
  return nested_path if Dir.exist?(nested_path)
  full_path
end

def get_changelog(platform_prefix, project_root)
  metadata_path = get_metadata_path(platform_prefix, project_root)
  changelog_file = File.join(metadata_path, "changelog.txt")
  if File.exist?(changelog_file) && !File.read(changelog_file).strip.empty?
    return File.read(changelog_file).strip
  else
    return "- Performance improvements and bug fixes."
  end
end

default_platform(:android)

platform :android do

  before_all do
    skip_docs
    update_fastlane
    # Detect project root from CI or local path
    @project_root = ENV["GITHUB_WORKSPACE"] ||        # GitHub Actions
                    ENV["CI_PROJECT_DIR"] ||          # GitLab
                    ENV["BUILD_SOURCESDIRECTORY"] ||  # Azure DevOps
                    find_project_root
    
    UI.user_error!("❌ Could not find Flutter project root!") unless @project_root
  end

  desc "Deploy to Play Store Production"
  lane :prod do
    deploy(track: "production")
  end

  desc "Deploy to Play Store Beta"
  lane :dev do
    deploy(track: "beta")
  end

  # Generic deploy logic using build artifact or manual build
  desc "Execute Play Store upload"
  lane :deploy do |options|
    track = options[:track] || "beta"

    aab_file = find_latest_aab(@project_root)
    unless aab_file && File.exist?(aab_file)
      UI.user_error!("❌ AAB file not found! Run 'flutter build appbundle' first.")
    end
    
    metadata_path = get_metadata_path('ANDROID', @project_root)
    metadata_exists = Dir.exist?(metadata_path)

    # Authenticate with Google Play
    json_key = env_with_flavor('ANDROID_SERVICE_ACCOUNT_PATH')
    json_key_data = env_with_flavor('ANDROID_SERVICE_ACCOUNT_JSON')

    upload_to_play_store(
      aab: aab_file,
      track: track,
      json_key: json_key_data ? nil : json_key,
      json_key_data: json_key_data,
      metadata_path: metadata_exists ? metadata_path : nil,
      skip_upload_metadata: !metadata_exists,
      skip_upload_images: !metadata_exists,
      skip_upload_screenshots: !metadata_exists,
      skip_upload_changelogs: !metadata_exists,
      release_status: "completed"
    )
  end
end
