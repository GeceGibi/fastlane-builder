require 'fileutils'

# Import shared helpers via absolute path to avoid symlink/CWD issues
import(File.expand_path("../../shared/helpers.rb", __FILE__))

def find_latest_aab(project_root)
  log_info("Searching for AAB in: #{project_root}/build/app/outputs/bundle")
  aab_pattern = File.join(project_root, "build/app/outputs/bundle/**/*.aab")
  aab_files = Dir.glob(aab_pattern)
  latest = aab_files.max_by { |f| File.mtime(f) }
  log_info("Found AAB: #{latest}") if latest
  latest
end

default_platform(:android)

platform :huawei do

  before_all do
    skip_docs
    update_fastlane
    
    dump_context('Huawei', [
      'HUAWEI_APP_ID',
      'HUAWEI_CLIENT_ID',
      'HUAWEI_CLIENT_SECRET'
    ])

    # Detect project root from CI or local path
    @project_root = ENV["GITHUB_WORKSPACE"] ||        # GitHub Actions
                    ENV["CI_PROJECT_DIR"] ||          # GitLab
                    ENV["BUILD_SOURCESDIRECTORY"] ||  # Azure DevOps
                    find_project_root
    
    UI.user_error!("❌ Could not find Flutter project root!") unless @project_root
    log_info("Project Root: #{@project_root}")

    # Ensure metadata structure exists
    ensure_metadata_dirs("HUAWEI", @project_root)
  end

  desc "Deploy to Huawei AppGallery Production"
  lane :prod do
    log_info("Starting PROD deployment (Review)...")
    deploy(submit_for_review: true)
  end

  desc "Upload to Huawei AppGallery Draft"
  lane :dev do
    log_info("Starting DEV deployment (Draft)...")
    update_changelog_from_git("HUAWEI", @project_root)
    deploy(submit_for_review: false)
  end

  # Generic deploy logic using build artifact
  desc "Execute Huawei upload"
  lane :deploy do |options|
    submit_for_review = options[:submit_for_review] || false

    aab_file = find_latest_aab(@project_root)
    unless aab_file && File.exist?(aab_file)
      UI.user_error!("❌ AAB file not found! Run 'flutter build appbundle' first.")
    end

    client_id = env_with_flavor("HUAWEI_CLIENT_ID")
    app_id = env_with_flavor("HUAWEI_APP_ID")
    
    log_info("Auth Info:")
    log_info("   ClientID: #{client_id}")
    log_info("   AppID:    #{app_id}")

    huawei_appgallery_connect(
      client_id: client_id,
      client_secret: env_with_flavor("HUAWEI_CLIENT_SECRET"),
      app_id: app_id,
      apk: aab_file,
      submit_for_review: submit_for_review
    )
  end
end
