# Shared Huawei Fastlane Configuration
# Usage: fastlane huawei dev/prod

default_platform(:android)

# Fetches ENV variable with flavor prefix support
# Example: FLAVOR=dev -> checks DEV_HUAWEI_APP_ID, then HUAWEI_APP_ID
def env_with_flavor(key)
  flavor = ENV['FLAVOR']
  if flavor && !flavor.empty?
    flavor_key = "#{flavor.upcase}_#{key}"
    return ENV[flavor_key] if ENV[flavor_key] && !ENV[flavor_key].empty?
  end
  ENV[key]
end

# Locates the most recently modified AAB file in the build directory
def find_latest_aab
  aab_pattern = File.join(@project_root, "build/app/outputs/bundle/**/*.aab")
  aab_files = Dir.glob(aab_pattern)
  return aab_files.max_by { |f| File.mtime(f) }
end

# Recursively searches up for pubspec.yaml to identify Flutter root
def find_project_root
  dir = Dir.pwd
  while dir != '/'
    return dir if File.exist?(File.join(dir, 'pubspec.yaml'))
    dir = File.dirname(dir)
  end
  nil
end

platform :huawei do

  before_all do
    skip_docs
    # Detect project root from CI or local path
    @project_root = ENV["GITHUB_WORKSPACE"] ||        # GitHub Actions
                    ENV["CI_PROJECT_DIR"] ||          # GitLab
                    ENV["BUILD_SOURCESDIRECTORY"] ||  # Azure DevOps
                    find_project_root
    
    UI.user_error!("❌ Could not find Flutter project root!") unless @project_root
  end

  desc "Deploy to Huawei AppGallery Production"
  lane :prod do
    deploy(submit_for_review: true)
  end

  desc "Upload to Huawei AppGallery Draft"
  lane :dev do
    deploy(submit_for_review: false)
  end

  # Generic deploy logic using build artifact
  desc "Execute Huawei upload"
  lane :deploy do |options|
    submit_for_review = options[:submit_for_review] || false

    aab_file = find_latest_aab
    unless aab_file && File.exist?(aab_file)
      UI.user_error!("❌ AAB file not found! Run 'flutter build appbundle' first.")
    end

    huawei_appgallery_connect(
      client_id: env_with_flavor("HUAWEI_CLIENT_ID"),
      client_secret: env_with_flavor("HUAWEI_CLIENT_SECRET"),
      app_id: env_with_flavor("HUAWEI_APP_ID"),
      apk: aab_file,
      submit_for_review: submit_for_review
    )
  end
end
