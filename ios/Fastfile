# Shared iOS Fastlane Configuration
# Usage: fastlane ios dev/prod

require_relative '../shared/helpers'

default_platform(:ios)

platform :ios do

  before_all do
    skip_docs
    # Detect project root from CI or local path
    @project_root = ENV["GITHUB_WORKSPACE"] ||        # GitHub Actions
                    ENV["CI_PROJECT_DIR"] ||          # GitLab
                    ENV["BUILD_SOURCESDIRECTORY"] ||  # Azure DevOps
                    find_project_root
    
    UI.user_error!("âŒ Could not find Flutter project root!") unless @project_root
  end

  desc "Deploy to TestFlight"
  lane :dev do
    deploy(production: false)
  end

  desc "Deploy to App Store"
  lane :prod do
    deploy(production: true)
  end

  # Shared deployment logic for iOS
  desc "Execute App Store / TestFlight upload"
  lane :deploy do |options|
    production = options[:production] || false
    
    ipa_file = find_latest_ipa(@project_root)
    unless ipa_file && File.exist?(ipa_file)
      UI.user_error!("âŒ IPA file not found! Run 'flutter build ipa' first.")
    end

    # Authenticate with App Store Connect
    # Supports either key file path or raw key content
    key_path = env_with_flavor('IOS_AUTH_KEY_PATH')
    key_content = env_with_flavor('IOS_AUTH_KEY_CONTENT')

    if key_content && !key_content.empty?
      key_path = File.join(@project_root, "ios/fastlane/auth_key.p8")
      File.write(key_path, key_content)
    end

    app_store_connect_api_key(
      key_id: env_with_flavor("IOS_AUTH_KEY_ID"),
      issuer_id: env_with_flavor("IOS_ISSUER_ID"),
      key_filepath: key_path,
    )

    # Configure transporter path if specified
    if env_with_flavor('IOS_USE_TRANSPORTER') != 'false'
      ENV["FASTLANE_ITUNES_TRANSPORTER_USE_SHELL_SCRIPT"] = "1"
      ENV["FASTLANE_ITUNES_TRANSPORTER_PATH"] = env_with_flavor('IOS_TRANSPORTER_PATH') || "/Applications/Transporter.app/Contents/itms"
    end

    if production
      upload_to_app_store(
        ipa: ipa_file,
        release_notes: { 'tr' => get_changelog("IOS") },
        skip_metadata: false,
        skip_screenshots: true,
        automatic_release: true,
        submit_for_review: true,
        force: true
      )
    else
      upload_to_testflight(
        ipa: ipa_file,
        skip_waiting_for_build_processing: true
      )
    end

    # Optional: Crashlytics dSYM upload
    if env_with_flavor('IOS_GOOGLE_SERVICE_PLIST_PATH')
      begin
        dSYMsPath = File.join(@project_root, "build/ios/archive/Runner.xcarchive/dSYMs")
        if File.exist?(dSYMsPath)
          upload_symbols_to_crashlytics(
            dsym_paths: Dir.children(dSYMsPath).map { |e| File.join(dSYMsPath, e) },
            gsp_path: env_with_flavor('IOS_GOOGLE_SERVICE_PLIST_PATH'),
          )
        end
      rescue => e
        UI.error("Crashlytics upload failed: #{e.message}")
      end
    end
  end
end
